<script src="https://cdn.jsdelivr.net/npm/appwrite@7.0.0"></script>

<button onclick="register()">Register Finn</button>
<button onclick="createPost()">Create Post</button>
<button onclick="login()">Login Finnus</button>
<button onclick="createCommentCall()">Create Comment</button>
<button onclick="createPostCall()">Create Post</button>
<button onclick="printBase64Img()">Print base64 string</button>

<div style="border: 2px solid black;margin:auto;margin-top:20px;max-width: fit-content;">
    <canvas onmousemove="drawPixel(event)" id="drawCanvas" width="320px" height="320px" onmousedown="editorMouseDown()">
    </canvas>
</div>

<div style="visibility: hidden;">
    <canvas id="hiddenCanvas" width="32px" height="32px">
</div>

<script>
    let mouseOnCanvasDown = false;

    let canvasEl = document.getElementById("drawCanvas");
    let context = canvasEl.getContext("2d");

    let hCanvasEl = document.getElementById("hiddenCanvas");
    let hContext = hCanvasEl.getContext("2d");

    function getMousePos(canvas, evt){
        let rect = canvas.getBoundingClientRect();
        return {
            x: evt.clientX - rect.left,
            y: evt.clientY - rect.top
        };
    }

    let last_pixel = {x:-1,y:-1};

    function drawPixel(evt) {
        if (mouseOnCanvasDown){
            let pos = getMousePos(canvasEl, evt);
            let pixel = {
                x: pos.x == 0 ? 0 : Math.ceil(pos.x/10-1),
                y: pos.y == 0 ? 0 : Math.ceil(pos.y/10-1)
            }
            if (last_pixel.x != pixel.x && last_pixel.y != pixel.y){
                context.fillStyle = "#000000";
                context.fillRect(pixel.x*10, pixel.y*10, 10, 10);

                hContext.fillStyle = "#000000";
                hContext.fillRect(pixel.x,pixel.y,1,1);
            }
        }
    }

    function printBase64Img() {
        console.log(hCanvasEl.toDataURL());
    }

    function editorMouseDown() {
        mouseOnCanvasDown  = true;
    }

    function mouseGlobalUp() {
        mouseOnCanvasDown = false;
    }

    document.addEventListener('mouseup', mouseGlobalUp);

    // Init your Web SDK
    const sdk = new Appwrite();
    sdk
        .setEndpoint('https://appwrite.berlin-fn.de/v1') // Your Appwrite Endpoint
        .setProject('pixlr') // Your project ID
        ;

    function register() {
        // Register User
        sdk
            .account.create('unique()', 'finn@finn.de', 'password', 'Finnus')
            .then(response => {
                console.log(response);
            }, error => {
                console.log(error);
            });
    }

    function login() {
        let promise = sdk.account.createSession('finn@finn.de', 'password');

        promise.then(function (response) {
            console.log(response); // Success
        }, function (error) {
            console.log(error); // Failure
        });
    }

    async function createCommentCall() {
            let data = {
                content: "Neuer Comment",
                post_id: "62603a243be27745d0ac"
            }
            let response;
            try {
                response = await sdk.functions.createExecution('create_comment', JSON.stringify(data), false);
            } catch (err) {
                console.error(err);
            }

            response = JSON.parse(response.stdout);
            console.log("status: "+ response.statusCode);
            if (response.statusCode > 299 || response.statusCode < 200) {
                console.error(response.error);
            }
    }

    async function createPostCall() {
        let data = {
            title: "Test Titel2",
            image64: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAMoSURBVFhHxZdNSFRRFMfPnQknxQSV1Ahm0aAQphjBgLWIFoJjECUkOlMwbmqhmyIialG0CIOIAl0UREXah32gG5PcSNSi0cLAILLaTOoIlg5pkzOMrzn3nfd878198+bD8AeXOefMx/3fc8899w2TEsAGYqPXDUPNwMz7GQh0j8HS3BJ/w0hheSHUeGvA1bCDIusDF4CTv+l6C9HlKIVTs55i2PT4tJTJ5FrWQwh75n0uRRYi5MpUNVWCu9NNHsBk/yeYuDdBnh57nh3aBlottxARCWYPPL3qKTBOLEIkxrnPCaGJUFpZRMHuDrcqwt5c2XyJWwk8Nz1kycRGX8Nvrx/+3rkPrKgINlXvhLLqMqj11UJsOQbzn+f558LBMMRjcW5bIcUlmP0wCwWlBVDiKtZnoP5UvS49i3sPwGrwB7eZwwHFXye5jcSjcXh0+DF5a4iyKMqasnU2NBQCPQGyZBy+VrISyldWyJLRfk8Bf1C0hbtaquHYkA/q/HUUkReA2LAoFDD4beQ7eQD5HSch/9wZbm8+3sZfzcCVi0RpQSFGbBg0ZuHL0BR5soiS4BQUXLlMERmsei3alWPt4PbhWHn6gqJieCs2ZiHQHYDepj4YaB/UZURBaVxmLJ+/yGsHx5+zFygqRm3Fqc56OuAeK0R6bkGk6xq3WWIUJzKogAtTwO+olxFuBRaRq8FFkcww1g5uGw7t5MZtQ0yv43QywuyMn2sE60jbYIyI7hvMQE7PA2YitS3XrEUr/SInAUg2taNtVsIHksB4GFr9k3wMj/ykqBisHW2DscLYKdUM4KTXu4MQmtN3PC0V5Q7w+7ZBY0MpRZIxy4ioRSPs3diiZDWxGSjIe7QcDh3cSpHMYUfaPkq/FmLk5kY6GTLC9jeO64oQV3O600neGg/7Q3D77jR51qQrRidg9OUesqyJRld5zQyPyM8EZlgJUQXU1W6BG1ereDAbUmUoL8/GsyoSoQpI9aFMEYnB3381uJu8NZJqAMmmmNI5xqItZn1PZqVMiitbzIrb5m2pgBPt28n9P5hNjiTdBZkeNyOpJhOR82WUKxv87xjgH9simFtOMRQkAAAAAElFTkSuQmCC"
        }

        let response;
        try {
            response = await sdk.functions.createExecution('create_post', JSON.stringify(data), false);
        } catch (err) {
            console.error(err);
        }

        response = JSON.parse(response.stdout);
        console.log("status: "+ response.statusCode);
        if (response.statusCode > 299 || response.statusCode < 200) {
            console.error(response.error);
        }
        console.log(response);
    }
</script>